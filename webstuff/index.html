<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Reef AI Doser</title>
<style>
  :root {
    --bg: #020817; 
    --bg-card: rgba(15, 23, 42, 0.96);
    --accent: #22d3ee; 
    --accent-soft: rgba(56, 189, 248, 0.18);
    --accent-strong: #38bdf8; 
    --text: #e2e8f0; 
    --text-soft: #94a3b8;
    --border: rgba(148, 163, 184, 0.35); 
    --danger: #f97373; 
    --success: #4ade80;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; min-height: 100vh; font-family: system-ui, -apple-system, sans-serif;
    background: radial-gradient(circle at top, #0ea5e9 0, #020617 40%, #020617 100%);
    color: var(--text); display: flex; justify-content: center; padding: 16px;
  }
  .shell { width: 100%; max-width: 1100px; }
  .glass-panel { background: var(--bg-card); border-radius: 18px; border: 1px solid var(--border); padding: 25px; backdrop-filter: blur(20px); box-shadow: 0 24px 60px rgba(15, 23, 42, 0.9); }
  
  header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; }
  .header-left { display: flex; align-items: center; gap: 15px; }
  
  .reef-icon {
    width: 48px; height: 48px; border-radius: 50%;
    background: radial-gradient(circle at 30% 20%, #e0f2fe, #0ea5e9 40%, #0369a1 70%, #020617 100%);
    box-shadow: 0 0 0 2px rgba(8, 47, 73, 0.8), 0 12px 26px rgba(12, 74, 110, 0.7);
    display: flex; align-items: center; justify-content: center;
  }
  .reef-icon-wave { width: 70%; height: 70%; border-radius: 50%; border: 2.5px solid rgba(255,255,255,0.9); border-top-color: transparent; border-left-color: transparent; transform: rotate(25deg); }
  
  .pill { font-size: 0.7rem; color: var(--accent); border: 1px solid var(--accent); padding: 3px 10px; border-radius: 999px; display: inline-block; margin-top: 5px; font-weight: 600; }
  
  .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 25px; margin-bottom: 25px; }
  .card { border-radius: 16px; border: 1px solid var(--border); background: rgba(15, 23, 42, 0.8); padding: 22px; position: relative; }
  
  label { font-size: 0.75rem; color: var(--text-soft); display: block; margin-top: 12px; font-weight: 500; }
  input { width: 100%; padding: 12px; border-radius: 10px; background: #000; border: 1px solid #333; color: #fff; margin-top: 6px; font-size: 1rem; }
  button { cursor: pointer; border-radius: 999px; border: none; padding: 12px 24px; font-weight: bold; transition: all 0.2s; }
  
  .btn-action { background: linear-gradient(135deg, var(--accent), #1d4ed8); color: #fff; width: 100%; margin-top: 20px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
  .btn-action:disabled { opacity: 0.6; cursor: not-allowed; }
  .btn-outline-soft { background: transparent; border: 1px solid var(--border); color: var(--text-soft); font-size: 0.8rem; }
  
  .log-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 15px; }
  .log-table th { text-align: left; color: var(--text-soft); padding: 12px 8px; border-bottom: 2px solid var(--border); }
  .log-table td { padding: 12px 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
  
  .tag { font-size: 0.75rem; padding: 8px 14px; border-radius: 999px; background: rgba(0,0,0,0.4); border: 1px solid #444; color: #fff; margin: 4px; display: inline-flex; align-items: center; gap: 8px; }
  .tag-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 8px var(--accent); }
  
  .modal-overlay { position: fixed; inset: 0; background: rgba(2, 8, 23, 0.98); z-index: 10000; display: flex; align-items: center; justify-content: center; }
  .hidden { display: none !important; }
</style>
</head>
<body>

  <div id="loginModal" class="modal-overlay">
    <div class="glass-panel" style="width:360px; text-align:center;">
      <h2 style="color:var(--accent); margin-bottom:25px; font-size: 2rem;">Reef AI</h2>
      <input id="loginEmail" type="email" placeholder="Email">
      <input id="loginPassword" type="password" placeholder="Password" style="margin-top: 15px;">
      <button id="loginButton" class="btn-action">Sign In</button>
      <div id="loginError" style="color:var(--danger); margin-top:15px; font-size:0.85rem;"></div>
    </div>
  </div>

  <div class="shell">
    <div class="glass-panel">
      <header>
        <div class="header-left">
          <div class="reef-icon"><div class="reef-icon-wave"></div></div>
          <div>
            <h1 style="margin:0; font-size: 2rem; letter-spacing: -1px;">Reef<span style="color:var(--accent)">AI</span></h1>
            <div class="pill">300 Gallon System</div>
          </div>
        </div>
        <div style="display: flex; gap: 12px;">
          <button id="openCalibrationBtn" class="btn-outline-soft" style="border-color: var(--accent); color: var(--accent);">Pump Calibration</button>
          <button id="logoutBtn" class="btn-outline-soft" style="color:var(--danger); border-color: rgba(249,115,115,0.3);">Logout</button>
        </div>
      </header>

      <div class="grid">
        <div class="card">
          <h3 style="color:var(--accent); margin-top:0;">Manual Test Entry</h3>
          <form id="testForm">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div><label>Alkalinity (dKH)</label><input id="alk" type="number" step="0.01" placeholder="eg. 8.5"></div>
              <div><label>Calcium (ppm)</label><input id="ca" type="number" step="0.1" placeholder="eg. 420"></div>
              <div><label>Magnesium (ppm)</label><input id="mg" type="number" step="1" placeholder="eg. 1350"></div>
              <div><label>pH Level</label><input id="ph" type="number" step="0.01" placeholder="eg. 8.2"></div>
            </div>
            <button type="submit" class="btn-action">Calculate & Sync</button>
          </form>
        </div>

        <div class="card">
          <h3 style="color:var(--accent); margin-top:0;">Active Dosing Plan</h3>
          <div id="dosingContainer" style="display: flex; flex-direction: column; gap: 10px;">
          </div>
          <p style="font-size: 0.75rem; color: var(--text-soft); margin-top: 25px; line-height: 1.5;">
            Calculated volumes are automatically spread across 24 dosing windows based on your reef's consumption.
          </p>
        </div>
      </div>

      <div class="card" style="margin-bottom: 25px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h3 style="color:var(--accent); margin:0;">Device & Firmware</h3>
          <div style="display: flex; gap: 8px;">
            <div id="liveStatusPill" class="tag" style="margin:0;"><div class="tag-dot" style="background:gray;"></div>Offline</div>
            <div id="firmwareInfo" class="tag" style="margin:0;">FW: --</div>
          </div>
        </div>
        <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; display: flex; gap: 15px; align-items: center;">
          <input type="file" id="otaFile" accept=".bin" style="margin:0; border:none; background:transparent; font-size:0.8rem; flex:1;">
          <button id="otaUploadBtn" class="btn-outline-soft" style="border-color: var(--accent); color: var(--accent);">Flash ESP32</button>
        </div>
        <div id="otaStatus" style="font-size:0.75rem; margin-top:10px; text-align:center; color: var(--accent); font-weight: 500;"></div>
      </div>

      <div class="card" style="margin-bottom: 25px;">
        <h3 style="color:var(--accent); margin-top:0;">Parameter Trends</h3>
        <div style="height:300px;"><canvas id="paramsChart"></canvas></div>
      </div>

      <div class="card">
        <h3 style="color:var(--accent); margin-top:0;">Historical Logs</h3>
        <table class="log-table">
          <thead><tr><th>Date</th><th>Alk</th><th>Ca</th><th>Mg</th><th>pH</th></tr></thead>
          <tbody id="logBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="calibrationOverlay" class="hidden modal-overlay">
    <div class="glass-panel" style="width:90%; max-width:900px; max-height:90vh; overflow-y:auto;">
      <div style="display:flex; justify-content:space-between; margin-bottom:25px; align-items: center;">
        <h2 style="margin:0;">Pump Calibration</h2>
        <div id="calibrationAck" style="font-size:12px;color:var(--text-soft);margin-top:6px;"></div>
        <button id="closeCalibrationBtn" class="btn-outline-soft" style="background:var(--danger); color:white; border:none; padding: 10px 20px;">Close</button>
      </div>
      <div class="grid" id="calGrid">
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDDjIg9vRzu8ap3Wt0KQQT-rAFf7rqWoRE",
      authDomain: "aidoser.firebaseapp.com",
      databaseURL: "https://aidoser-default-rtdb.firebaseio.com",
      projectId: "aidoser",
      storageBucket: "aidoser.firebasestorage.app",
      messagingSenderId: "838844198786",
      appId: "1:838844198786:web:037fd66c256f074a21a99b"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    let activeDeviceId = null;
    let paramsChart = null;

    document.getElementById('loginButton').onclick = () => {
      auth.signInWithEmailAndPassword(document.getElementById('loginEmail').value, document.getElementById('loginPassword').value)
        .catch(e => document.getElementById('loginError').innerText = e.message);
    };
    document.getElementById('logoutBtn').onclick = () => auth.signOut();

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById('loginModal').classList.add('hidden');
        db.ref(`users/${user.uid}/devices`).once('value', snap => {
          if(snap.exists()){
            activeDeviceId = Object.keys(snap.val())[0];
            initApp();
          }
        });
      } else {
        document.getElementById('loginModal').classList.remove('hidden');
      }
    });

    function initApp() {
      db.ref(`devices/${activeDeviceId}/dosingPlan`).on('value', s => {
        const plan = s.val() || {};
        const cont = document.getElementById('dosingContainer');
        cont.innerHTML = '';
        Object.keys(plan).forEach(k => {
          cont.innerHTML += `<div class="tag"><div class="tag-dot"></div><span style="text-transform:capitalize">${k}</span>: ${plan[k]} ml/day</div>`;
        });
      });

      db.ref(`devices/${activeDeviceId}/state`).on('value', s => {
        const st = s.val() || {};
        const pill = document.getElementById('liveStatusPill');
        pill.innerHTML = st.online ? '<div class="tag-dot" style="background:#4ade80"></div>Online' : '<div class="tag-dot" style="background:gray"></div>Offline';
        document.getElementById('firmwareInfo').innerText = "FW: " + (st.fwVersion || "1.0.0");
      });

      db.ref(`devices/${activeDeviceId}/tests`).on('value', s => {
        const data = s.val() || {};
        const sorted = Object.values(data).sort((a,b) => a.timestamp - b.timestamp);
        updateChart(sorted);
        updateTable(sorted);
      });

      setupCalibrationUI();
    }

    // RESTORED: TRiggers OTA by notifying RTDB of the local selection
    document.getElementById('otaUploadBtn').onclick = function() {
      const fileInput = document.getElementById('otaFile');
      if(fileInput.files.length === 0) return alert("Please select a .bin file from your local directory.");
      
      const fileName = fileInput.files[0].name;
      const status = document.getElementById('otaStatus');
      status.innerText = "Triggering OTA for: " + fileName;

      // Restored the trigger path for the Firebase Hosting local mapping
      const hostingUrl = "https://aidoser.web.app/" + fileName;

      db.ref(`devices/${activeDeviceId}/otaRequest`).set({ 
        url: hostingUrl, 
        requestedAt: firebase.database.ServerValue.TIMESTAMP 
      }).then(() => {
        status.innerText = "OTA Request Sent. ESP32 is pulling from Hosting.";
      }).catch(err => {
        status.innerText = "Error: " + err.message;
      });
    };

    function updateChart(tests) {
      if (paramsChart) paramsChart.destroy();
      const ctx = document.getElementById('paramsChart').getContext('2d');
      paramsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: tests.map(t => new Date(t.timestamp).toLocaleDateString()),
          datasets: [
            { label: 'Alk (dKH)', data: tests.map(t => t.alk), tension: 0.3, yAxisID: 'yAlk' },
            { label: 'Ca (ppm)',  data: tests.map(t => t.ca),  tension: 0.3, yAxisID: 'yPpm' },
            { label: 'Mg (ppm)',  data: tests.map(t => t.mg),  tension: 0.3, yAxisID: 'yPpm' },
            { label: 'pH',        data: tests.map(t => t.ph),  tension: 0.3, yAxisID: 'yPh'  }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: {
            y: { type: 'linear', display: true, position: 'left', grid: { color: 'rgba(255,255,255,0.05)' } },
            y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false } }
          }
        }
      });
    }

    function updateTable(tests) {
      const body = document.getElementById('logBody');
      body.innerHTML = '';
      [...tests].reverse().forEach(t => {
        body.innerHTML += `<tr><td>${new Date(t.timestamp).toLocaleDateString()}</td><td>${t.alk}</td><td>${t.ca}</td><td>${t.mg}</td><td>${t.ph}</td></tr>`;
      });
    }

    function setupCalibrationUI() {
      const names = ["Kalkwasser (P1)", "All-For-Reef (P2)", "Magnesium (P3)", "Auxiliary (P4)"];
      const grid = document.getElementById('calGrid');
      grid.innerHTML = '';
      
      names.forEach((name, i) => {
        const n = i + 1;
        const card = document.createElement('div');
        card.className = 'card';
        card.style.textAlign = 'center';
        card.innerHTML = `
          <div style="font-size:0.65rem; color:var(--text-soft); margin-bottom:5px;">PUMP ${n}</div>
          <div style="font-weight:bold; margin-bottom:15px; color:var(--accent);">${name}</div>
          <button id="startCal${n}" class="btn-action" style="background:var(--success); margin:0;">Start 60s Test</button>
          <input id="calPump${n}Ml" type="number" placeholder="ml caught" style="margin: 15px 0; text-align:center;">
          <button id="saveCal${n}" class="btn-outline-soft" style="width:100%; padding: 12px;">Save ml/min</button>
          <div id="calStatus${n}" style="margin-top:10px;font-size:12px;color:var(--text-soft);text-align:center;"></div>
        `;
        grid.appendChild(card);

        const startBtn = document.getElementById(`startCal${n}`);
        startBtn.onclick = function() {
          this.disabled = true;
          db.ref(`devices/${activeDeviceId}/commands/calibrate`).set({ trigger:true, pump: n, durationSec: 60, status: "pending", ts: Date.now() });
          
          let seconds = 60;
          const timer = setInterval(() => {
            this.innerText = `Running... ${seconds}s`;
            seconds--;
            if (seconds < 0) {
              clearInterval(timer);
              this.disabled = false;
              this.innerText = "Start 60s Test";
            }
          }, 1000);
        };

        document.getElementById(`saveCal${n}`).onclick = async () => {
          const statusEl = document.getElementById(`calStatus${n}`);
          const valRaw = document.getElementById(`calPump${n}Ml`).value;
          const val = parseFloat(valRaw);
          if(!isFinite(val) || val <= 0) return alert("Measure the output first (enter ml caught).");

          if (!activeDeviceId) return alert("No active device selected.");

          statusEl.innerText = "Saving…";
          try {
            await db.ref(`devices/${activeDeviceId}/calibration/pumps/pump${n}`).set({
              ml_per_min: val,      // 60 seconds test => ml/min
              ml_per_60s: val,
              ts: Date.now()
            });
            statusEl.innerText = "✅ Saved to cloud. Waiting for ESP32 to apply…";
          } catch (err) {
            statusEl.innerText = "❌ Save failed: " + (err?.message || err);
          }
        };
      });
    }

    document.getElementById('testForm').onsubmit = (e) => {
      e.preventDefault();
      db.ref(`devices/${activeDeviceId}/tests`).push({
        alk: parseFloat(document.getElementById('alk').value),
        ca: parseFloat(document.getElementById('ca').value),
        mg: parseFloat(document.getElementById('mg').value),
        ph: parseFloat(document.getElementById('ph').value),
        timestamp: Date.now()
      });
      alert("Results synced with Reef AI.");
    };

    let calStatusUnsub = null;
    function attachCalibrationStatusListener() {
      if (!activeDeviceId) return;
      const ackEl = document.getElementById('calibrationAck');
      if (!ackEl) return;

      // Detach old
      if (calStatusUnsub) { try { calStatusUnsub(); } catch(e){} calStatusUnsub = null; }

      const ref = db.ref(`devices/${activeDeviceId}/calibration/status`);
      const handler = (snap) => {
        const v = snap.val();
        if (!v) { ackEl.innerText = "No calibration status from ESP32 yet."; return; }
        const when = v.appliedAt ? new Date(v.appliedAt).toLocaleString() : "—";
        const flows = v.flows || {};
        const k = flows.kalk ?? "—";
        const a = flows.afr ?? "—";
        const m = flows.mg ?? "—";
        const x = flows.aux ?? "—";
        ackEl.innerText = `ESP32 applied: ${when}  |  KALK ${k} ml/min, AFR ${a}, MG ${m}, AUX ${x}`;
      };
      ref.on('value', handler);
      calStatusUnsub = () => ref.off('value', handler);
    }

    document.getElementById('openCalibrationBtn').onclick = () => {
      document.getElementById('calibrationOverlay').classList.remove('hidden');
      attachCalibrationStatusListener();
    };
    document.getElementById('closeCalibrationBtn').onclick = () => {
      document.getElementById('calibrationOverlay').classList.add('hidden');
      if (calStatusUnsub) { try { calStatusUnsub(); } catch(e){} calStatusUnsub = null; }
    };
  </script>
</body>
</html>