<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Reef AI Doser</title>
<style>
  :root {
    --bg: #020817;
    --bg-card: rgba(15, 23, 42, 0.96);
    --accent: #22d3ee;
    --accent-soft: rgba(56, 189, 248, 0.18);
    --accent-strong: #38bdf8;
    --text: #e2e8f0;
    --text-soft: #94a3b8;
    --border: rgba(148, 163, 184, 0.35);
    --danger: #f97373;
    --success: #4ade80;
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    min-height: 100vh;
    font-family: system-ui, -apple-system, sans-serif;
    background: radial-gradient(circle at top, #0ea5e9 0, #020617 40%, #020617 100%);
    color: var(--text);
    display: flex;
    justify-content: center;
    padding: 16px;
  }
  .shell { width: 100%; max-width: 1100px; }
  .glass-panel {
    background: var(--bg-card);
    border-radius: 18px;
    border: 1px solid var(--border);
    padding: 25px;
    backdrop-filter: blur(20px);
    box-shadow: 0 24px 60px rgba(15, 23, 42, 0.9);
  }

  header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 30px; gap: 12px; }
  .header-left { display:flex; align-items:center; gap: 15px; }

  .reef-icon {
    width: 48px; height: 48px; border-radius: 50%;
    background: radial-gradient(circle at 30% 20%, #e0f2fe, #0ea5e9 40%, #0369a1 70%, #020617 100%);
    box-shadow: 0 0 0 2px rgba(8, 47, 73, 0.8), 0 12px 26px rgba(12, 74, 110, 0.7);
    display:flex; align-items:center; justify-content:center;
  }
  .reef-icon-wave {
    width: 70%; height: 70%;
    border-radius: 50%;
    border: 2.5px solid rgba(255,255,255,0.9);
    border-top-color: transparent;
    border-left-color: transparent;
    transform: rotate(25deg);
  }

  .pill {
    font-size: 0.7rem;
    color: var(--accent);
    border: 1px solid var(--accent);
    padding: 3px 10px;
    border-radius: 999px;
    display: inline-block;
    margin-top: 5px;
    font-weight: 600;
  }

  .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 25px; margin-bottom: 25px; }
  .card {
    border-radius: 16px;
    border: 1px solid var(--border);
    background: rgba(15, 23, 42, 0.8);
    padding: 22px;
    position: relative;
  }

  label { font-size: 0.75rem; color: var(--text-soft); display:block; margin-top: 12px; font-weight: 500; }
  input {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    background: #000;
    border: 1px solid #333;
    color: #fff;
    margin-top: 6px;
    font-size: 1rem;
  }

  button { cursor:pointer; border-radius: 999px; border: none; padding: 12px 24px; font-weight:bold; transition: all 0.2s; }
  .btn-action {
    background: linear-gradient(135deg, var(--accent), #1d4ed8);
    color: #fff;
    width: 100%;
    margin-top: 20px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  }
  .btn-action:disabled { opacity: 0.6; cursor: not-allowed; }

  .btn-outline-soft {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-soft);
    font-size: 0.8rem;
  }
  .btn-outline-soft:hover { border-color: var(--accent); color: var(--accent); }

  .btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-soft);
    font-size: 0.85rem;
    border-radius: 999px;
    padding: 10px 16px;
    font-weight: 700;
  }
  .btn:hover { border-color: var(--accent); color: var(--accent); }
  .muted { color: var(--text-soft); font-size: 0.85rem; margin-top: 8px; }

  .tag {
    font-size: 0.75rem;
    padding: 8px 14px;
    border-radius: 999px;
    background: rgba(0,0,0,0.4);
    border: 1px solid #444;
    color: #fff;
    margin: 4px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
  }
  .tag-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 8px var(--accent);
  }

  .log-table { width:100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 15px; }
  .log-table th { text-align:left; color: var(--text-soft); padding: 12px 8px; border-bottom: 2px solid var(--border); }
  .log-table td { padding: 12px 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }

  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(2, 8, 23, 0.98);
    z-index: 10000;
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 14px;
  }
  .hidden { display: none !important; }

  code { background: rgba(0,0,0,0.35); padding: 2px 6px; border-radius: 8px; }

/* ---- Active Plan + Schedule side-by-side ---- */
.plan-grid{
  grid-column: 1 / -1;
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:16px;
  align-items:stretch;
}
.plan-grid .card{height:100%;}
@media (max-width: 900px){
  .plan-grid{
  grid-column: 1 / -1;grid-template-columns:1fr;}
}

</style>
</head>

<body>

  <!-- LOGIN MODAL -->
  <div id="loginModal" class="modal-overlay">
    <div class="glass-panel" style="width:360px; text-align:center;">
      <h2 style="color:var(--accent); margin-bottom:25px; font-size: 2rem;">Reef AI</h2>
      <input id="loginEmail" type="email" placeholder="Email">
      <input id="loginPassword" type="password" placeholder="Password" style="margin-top: 15px;">
      <button id="loginButton" class="btn-action">Sign In</button>
      <div id="loginError" style="color:var(--danger); margin-top:15px; font-size:0.85rem;"></div>
    </div>
  </div>

  <div class="shell">
    <div class="glass-panel">

      <header>
        <div class="header-left">
          <div class="reef-icon"><div class="reef-icon-wave"></div></div>
          <div>
            <h1 style="margin:0; font-size: 2rem; letter-spacing: -1px;">
              Reef<span style="color:var(--accent)">AI</span>
            </h1>
            <div class="pill">300 Gallon System</div>
          </div>
        </div>

        <div style="display:flex; gap: 12px; flex-wrap: wrap; justify-content: flex-end;">
          <button id="openDoseGraphBtn" class="btn-outline-soft" style="border-color: var(--accent); color: var(--accent);">Dosing History</button>
          <button id="openCalibrationBtn" class="btn-outline-soft" style="border-color: var(--accent); color: var(--accent);">Pump Calibration</button>
          <button id="logoutBtn" class="btn-outline-soft" style="color:var(--danger); border-color: rgba(249,115,115,0.3);">Logout</button>
        </div>
      </header>
      <!-- PARAMETER CHART -->
      <div class="card" style="margin-bottom: 25px;">
        <h3 style="color:var(--accent); margin-top:0;">Parameter Trends</h3>
        <div style="height:300px;"><canvas id="paramsChart"></canvas></div>
      </div>


      <div class="grid">

        <div class="card">
          <h3 style="color:var(--accent); margin-top:0;">Manual Test Entry</h3>
          <form id="testForm">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div><label>Alkalinity (dKH)</label><input id="alk" type="number" step="0.01" placeholder="eg. 8.5"></div>
              <div><label>Calcium (ppm)</label><input id="ca" type="number" step="0.1" placeholder="eg. 420"></div>
              <div><label>Magnesium (ppm)</label><input id="mg" type="number" step="1" placeholder="eg. 1350"></div>
              <div><label>pH Level</label><input id="ph" type="number" step="0.01" placeholder="eg. 8.2"></div>
            </div>
            <button type="submit" class="btn-action">Calculate & Sync</button>
          </form>
        </div>


        <div class="card">
          <h3 style="color:var(--accent); margin-top:0;">Live Dose</h3>
          <div class="muted">Send a one-time dose command to the ESP32 via <code>commands/liveDose</code>. It will run the pump and log to dosing history.</div>

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
            <div>
              <label>Pump</label>
              <select id="liveDosePump">
                <option value="1">Pump 1 (Kalk)</option>
                <option value="2">Pump 2 (AFR)</option>
                <option value="3">Pump 3 (Mag)</option>
                <option value="4">Pump 4 (Aux)</option>
              </select>
            </div>
            <div>
              <label>mL</label>
              <input id="liveDoseMl" type="number" step="0.1" min="0" placeholder="eg. 10">
            </div>
          </div>

          <button id="liveDoseBtn" class="btn-action">Run Live Dose</button>
          <div style="margin-top:10px;">
            <span class="pill" id="liveDoseStatus" style="border-color: rgba(56,189,248,0.35); color: var(--text-soft);">—</span>
          </div>
        </div>

<div class="plan-grid">
<div class="card">
          <h3 style="color:var(--accent); margin-top:0;">Active Dosing Plan</h3>
          <div id="dosingContainer" style="display:flex; flex-direction: column; gap: 10px;"></div>
          <p style="font-size: 0.75rem; color: var(--text-soft); margin-top: 25px; line-height: 1.5;">
            Calculated volumes are automatically spread across 24 dosing windows based on your reef's consumption.
          </p>
        </div>
<div class="card">
          <h3 style="color:var(--accent); margin-top:0;">Dosing Schedule</h3>
          <div class="muted">
            Choose when the ESP32 is allowed to dose and how often. The ESP32 will automatically split each pump's <b>ml/day</b>
            across the dosing intervals inside the window.
          </div>

          <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 12px;">
            <div>
              <label>Start hour</label>
              <select id="schedStart"></select>
            </div>
            <div>
              <label>End hour</label>
              <select id="schedEnd"></select>
            </div>
            <div>
              <label>Interval</label>
              <select id="schedEvery">
                <option value="15">Every 15 minutes</option>
                <option value="60">Every 1 hour</option>
                <option value="120">Every 2 hours</option>
                <option value="240">Every 4 hours</option>
              </select>
            </div>
          </div>

          <div style="display:flex; gap: 10px; align-items:center; flex-wrap:wrap; margin-top: 14px;">
            <button id="schedSaveBtn" class="btn-action">Save Schedule</button>
            <span class="pill" id="schedStatus" style="border-color: rgba(56,189,248,0.35); color: var(--text-soft);">—</span>
          </div>

          <div class="muted" style="margin-top:10px;">
            Saved to <code>devices/&lt;deviceId&gt;/settings/doseSchedule</code> as:
            <code>{ startHour, endHour, everyMin }</code>.
          </div>
        </div>
</div>


          <div class="muted" id="liveDoseLast" style="margin-top:6px;">Last: —</div>

        

        

      </div>

      <!-- DEVICE & OTA -->
      <div class="card" style="margin-bottom: 25px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px; gap: 10px; flex-wrap: wrap;">
          <h3 style="color:var(--accent); margin:0;">Device & Firmware</h3>
          <div style="display:flex; gap: 8px; flex-wrap: wrap; justify-content:flex-end;">
            <div id="deviceIdPill" class="tag" style="margin:0;">Device: —</div>
            <div id="liveStatusPill" class="tag" style="margin:0;">
              <div class="tag-dot" style="background:#f97373; box-shadow: 0 0 10px rgba(249,115,115,0.7);"></div>Offline
            </div>
            <div id="firmwareInfo" class="tag" style="margin:0;">FW: --</div>
          </div>
        </div>

<div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; display:flex; gap: 15px; align-items:center;">
  <div style="flex:1; font-size:0.8rem; color:var(--text-soft);">
    OTA source:
    <span id="otaUrlText" style="color:var(--accent); font-weight:700;"></span>
  </div>
  <button id="otaUploadBtn" class="btn-outline-soft" style="border-color: var(--accent); color: var(--accent);">
    Flash ESP32
  </button>
</div>
<div id="otaStatus" style="font-size:0.75rem; margin-top:10px; text-align:center; color: var(--accent); font-weight: 600;"></div>
        <!-- QUICK ACCESS: Dosing History -->


        <div style="margin-top:12px;">
          <button class="btn" id="enablePushBtn">Enable iPhone Notifications</button>
          <div class="muted" id="pushStatus">Push: not enabled</div>
        </div>
      </div>

      <!-- TEST LOG -->
      <div class="card">
        <h3 style="color:var(--accent); margin-top:0;">Historical Logs</h3>
        <table class="log-table">
          <thead><tr><th>Date</th><th>Alk</th><th>Ca</th><th>Mg</th><th>pH</th></tr></thead>
          <tbody id="logBody"></tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- CALIBRATION OVERLAY -->
  <div id="calibrationOverlay" class="hidden modal-overlay">
    <div class="glass-panel" style="width:90%; max-width:900px; max-height:90vh; overflow-y:auto;">
      <div style="display:flex; justify-content:space-between; margin-bottom:25px; align-items: center; gap: 12px; flex-wrap: wrap;">
        <div>
          <h2 style="margin:0;">Pump Calibration</h2>
          <div id="calibrationAck" class="muted" style="font-size:12px;margin-top:6px;"></div>
        </div>
        <button id="closeCalibrationBtn" class="btn-outline-soft" style="background:var(--danger); color:white; border:none; padding: 10px 20px;">Close</button>
      </div>
      <div class="grid" id="calGrid"></div>
    </div>
  </div>

  <!-- DOSE GRAPH OVERLAY -->
  <div id="doseGraphOverlay" class="hidden modal-overlay">
    <div class="glass-panel" style="width:90%; max-width:1000px; max-height:90vh; overflow-y:auto;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px; flex-wrap: wrap;">
        <div>
          <h2 style="margin:0;">Dosing History</h2>
          <div class="muted" style="margin-top:6px;">
            Plots <b>ml per run</b> from <code>devices/&lt;deviceId&gt;/doseRuns</code>.
          </div>
        </div>
        <button id="closeDoseGraphBtn" class="btn-outline-soft"
          style="background:var(--danger); color:white; border:none; padding: 10px 20px;">
          Close
        </button>
      </div>

      <div class="card" style="margin-bottom:16px;">
        <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;">
          <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
            <span class="tag" style="margin:0;"><div class="tag-dot"></div>Filter</span>
            <button class="btn-outline-soft" id="doseTabAll">All</button>
            <button class="btn-outline-soft" id="doseTabKalk">Kalk</button>
            <button class="btn-outline-soft" id="doseTabAfr">AFR</button>
            <button class="btn-outline-soft" id="doseTabMg">Mg</button>
            <button class="btn-outline-soft" id="doseTabAux">Aux</button>
          </div>
          <div class="muted" id="doseGraphMeta" style="margin:0;">Loading…</div>
        </div>
      </div>

      


<div class="card">
        <div style="height:360px;"><canvas id="doseChart"></canvas></div>

        <div class="muted" style="margin-top:10px;">
          Supported log formats:
          <code>{ pump:"kalk", ml:12.3, ts:... }</code>
          or <code>{ pump:"kalk", durationSec: 60, ml_per_min: 650, ts:... }</code>
        </div>

        <table class="log-table" style="margin-top:14px;">
          <thead><tr><th>Time</th><th>Pump</th><th>ml</th></tr></thead>
          <tbody id="doseRunsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- LIBS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDDjIg9vRzu8ap3Wt0KQQT-rAFf7rqWoRE",
      authDomain: "aidoser.firebaseapp.com",
      databaseURL: "https://aidoser-default-rtdb.firebaseio.com",
      projectId: "aidoser",
      storageBucket: "aidoser.firebasestorage.app",
      messagingSenderId: "838844198786",
      appId: "1:838844198786:web:037fd66c256f074a21a99b"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let activeDeviceId = null;

    // charts
    let paramsChart = null;
    let doseChart = null;

    // dose runs listener
    let doseRunsUnsub = null;
    let doseFilter = "all"; // all | kalk | afr | mg | aux

    // ---- AUTH UI ----
    document.getElementById('loginButton').onclick = () => {
      auth.signInWithEmailAndPassword(
        document.getElementById('loginEmail').value,
        document.getElementById('loginPassword').value
      ).catch(e => document.getElementById('loginError').innerText = e.message);
    };
    document.getElementById('logoutBtn').onclick = () => auth.signOut();

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById('loginModal').classList.add('hidden');
        db.ref(`users/${user.uid}/devices`).once('value', snap => {
          if (snap.exists()) {
            const devMap = snap.val() || {};
            const ids = Object.keys(devMap);
            // Prefer reefDoser6 if present, otherwise first device
            activeDeviceId = ids.includes("reefDoser6") ? "reefDoser6" : (ids[0] || null);

            const devPill = document.getElementById('deviceIdPill');
            if (devPill) devPill.innerText = "Device: " + activeDeviceId;

            initApp();
          }
        });
      } else {
        activeDeviceId = null;
        document.getElementById('loginModal').classList.remove('hidden');
      }
    });

    function initApp() {
      // dosing plan pills
      db.ref(`devices/${activeDeviceId}/dosingPlan`).on('value', s => {
        const plan = s.val() || {};
        const cont = document.getElementById('dosingContainer');
        cont.innerHTML = '';
        Object.keys(plan).forEach(k => {
          cont.innerHTML += `<div class="tag"><div class="tag-dot"></div><span style="text-transform:capitalize">${k}</span>: ${plan[k]} ml/day</div>`;
        });
      });

      // live status pills
      db.ref(`devices/${activeDeviceId}/state`).on('value', (s) => {
  const st = s.val() || {};
  const online =
    st.online === true ||
    st.online === "true" ||
    st.online === 1 ||
    st.online === "1";

  const pill = document.getElementById("liveStatusPill");
  if (pill) {
    pill.innerHTML = online
      ? '<div class="tag-dot" style="background:#4ade80; box-shadow:0 0 10px rgba(74,222,128,.7);"></div>Online'
      : '<div class="tag-dot" style="background:#f97373; box-shadow:0 0 10px rgba(249,115,115,.7);"></div>Offline';
  }

  const fw = document.getElementById("firmwareInfo");
  if (fw) fw.innerText = "FW: " + (st.fwVersion || "--");
});

      // tests -> chart/table
      db.ref(`devices/${activeDeviceId}/tests`).on('value', s => {
        const data = s.val() || {};
        const sorted = Object.values(data).sort((a,b) => (a.timestamp||0) - (b.timestamp||0));
        updateParamsChart(sorted);
        updateTestTable(sorted);
      });

      setupCalibrationUI();
      
      setupScheduleUI();
setupLiveDoseUI();
    }

    // ---- OTA trigger ----
    document.getElementById('otaUploadBtn').onclick = function() {
      const fileInput = document.getElementById('otaFile');
      if (fileInput.files.length === 0) return alert("Please select a .bin file.");

      const fileName = fileInput.files[0].name;
      const status = document.getElementById('otaStatus');
      status.innerText = "Triggering OTA for: " + fileName;

      // You’ve been using device-specific hosting paths:
      // https://aidoser.web.app/devices/<deviceId>/firmware.bin
      // Keep it consistent with what works for your ESP32:
      const hostingUrl = `https://aidoser.web.app/devices/${activeDeviceId}/firmware.bin`;

      db.ref(`devices/${activeDeviceId}/otaRequest`).set({
  trigger: true,
  fileName: "firmware.bin",
  url: hostingUrl,
  requestedAt: firebase.database.ServerValue.TIMESTAMP
}).then(() => {
        status.innerText = "OTA Request Sent. ESP32 will pull from Hosting.";
      }).catch(err => {
        status.innerText = "Error: " + err.message;
      });
    };

    // ---- PARAMS CHART ----
    function updateParamsChart(tests) {
  if (paramsChart) paramsChart.destroy();
  const ctx = document.getElementById('paramsChart').getContext('2d');

  paramsChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: tests.map(t => new Date(t.timestamp).toLocaleDateString()),
      datasets: [
        // LEFT axis (small numbers)
        { label: 'Alk (dKH)', data: tests.map(t => t.alk), tension: 0.3, yAxisID: 'ySmall' },
        { label: 'pH',       data: tests.map(t => t.ph),  tension: 0.3, yAxisID: 'ySmall' },

        // RIGHT axis (big numbers)
        { label: 'Ca (ppm)', data: tests.map(t => t.ca),  tension: 0.3, yAxisID: 'yBig'   },
        { label: 'Mg (ppm)', data: tests.map(t => t.mg),  tension: 0.3, yAxisID: 'yBig'   },
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      scales: {
        // LEFT: Alk + pH
        ySmall: {
          type: 'linear',
          position: 'left',
          grid: { color: 'rgba(255,255,255,0.05)' },
          // Optional: keep this axis sensible for reef numbers
          suggestedMin: 7.6,
          suggestedMax: 10.6
        },

        // RIGHT: Ca + Mg
        yBig: {
          type: 'linear',
          position: 'right',
          grid: { drawOnChartArea: false },
          // Optional: keep this axis sensible for reef numbers
          suggestedMin: 350,
          suggestedMax: 1600
        }
      }
    }
  });
}

    function updateTestTable(tests) {
      const body = document.getElementById('logBody');
      body.innerHTML = '';
      [...tests].reverse().forEach(t => {
        body.innerHTML += `<tr>
          <td>${new Date(t.timestamp).toLocaleDateString()}</td>
          <td>${t.alk}</td><td>${t.ca}</td><td>${t.mg}</td><td>${t.ph}</td>
        </tr>`;
      });
    }

    // ---- TEST ENTRY ----
    document.getElementById('testForm').onsubmit = (e) => {
      e.preventDefault();
      db.ref(`devices/${activeDeviceId}/tests`).push({
        alk: parseFloat(document.getElementById('alk').value),
        ca: parseFloat(document.getElementById('ca').value),
        mg: parseFloat(document.getElementById('mg').value),
        ph: parseFloat(document.getElementById('ph').value),
        timestamp: Date.now()
      });
      alert("Results synced with Reef AI.");
    };

    // ---- CALIBRATION ----

    // ---- LIVE DOSE (Finish A) ----
    function setupLiveDoseUI() {
      const btn = document.getElementById('liveDoseBtn');
      const pumpSel = document.getElementById('liveDosePump');
      const mlInput = document.getElementById('liveDoseMl');
      const statusEl = document.getElementById('liveDoseStatus');
      const lastEl = document.getElementById('liveDoseLast');

      function setStatus(text, tone) {
        if (!statusEl) return;
        statusEl.innerText = text || "—";
        // tone: ok | bad | info
        if (tone === "ok") {
          statusEl.style.borderColor = "rgba(74,222,128,0.55)";
          statusEl.style.color = "#bbf7d0";
        } else if (tone === "bad") {
          statusEl.style.borderColor = "rgba(249,115,115,0.55)";
          statusEl.style.color = "#fecaca";
        } else {
          statusEl.style.borderColor = "rgba(56,189,248,0.35)";
          statusEl.style.color = "var(--text-soft)";
        }
      }

      if (!btn || !pumpSel || !mlInput) return;

      
// Watch the command node for progress/completion (ESP32 will set trigger:false and lastRun)
const cmdRef = db.ref(`devices/${activeDeviceId}/commands/liveDose`);
cmdRef.off(); // avoid duplicate listeners if initApp re-runs
cmdRef.on('value', snap => {
  const v = snap.val() || {};
  if (v.trigger === true) {
    setStatus("Running…", "info");
  } else if (v.lastRun) {
    const when = new Date(v.lastRun).toLocaleString();
    setStatus(`✅ Complete (logged) • ${when}`, "ok");
  } else {
    setStatus("—", "info");
  }
});

// Show last logged dose run (reads from devices/<id>/doseRuns)
if (lastEl) {
  const lastRef = db.ref(`devices/${activeDeviceId}/doseRuns`).limitToLast(1);
  lastRef.off();
  lastRef.on('value', snap => {
    const obj = snap.val() || {};
    const keys = Object.keys(obj);
    if (!keys.length) { lastEl.textContent = "Last: —"; return; }
    const r = obj[keys[0]] || {};
    const ts = r.ts || r.timestamp || r.time || 0;
    const pump = (r.pump || r.pumpName || r.type || "—");
    const ml = (typeof r.ml === "number") ? r.ml : Number(r.ml);
    const when = ts ? new Date(Number(ts)).toLocaleString() : "—";
    const mlText = isFinite(ml) ? ml.toFixed(1) + " mL" : "—";
    lastEl.textContent = `Last: ${pump} • ${mlText} • ${when}`;
  });
}

      btn.onclick = async () => {
        const pump = parseInt(pumpSel.value, 10);
        const ml = parseFloat(mlInput.value);
        if (!pump || pump < 1 || pump > 4) return setStatus("Pick a pump (1–4).", "bad");
        if (!isFinite(ml) || ml <= 0) return setStatus("Enter a valid mL amount.", "bad");

        btn.disabled = true;
        setStatus("Queued…", "info");

        const reqId = "live_" + Date.now();
        try {
          await db.ref(`devices/${activeDeviceId}/commands/liveDose`).set({
            trigger: true,
            status: "pending",
            reqId,
            pump,
            ml,
            requestedAt: firebase.database.ServerValue.TIMESTAMP
          });
          // ESP32 will flip trigger:false and write lastRun; listener above updates status
        } catch (e) {
          setStatus("Error: " + (e.message || e), "bad");
        } finally {
          btn.disabled = false;
        }
      };
    }

    // ---- DOSING SCHEDULE (UI -> RTDB settings/doseSchedule) ----
    function hourLabel(h) {
      const hh = Number(h) % 24;
      const ampm = hh < 12 ? "AM" : "PM";
      const h12 = (hh % 12) === 0 ? 12 : (hh % 12);
      return `${h12}:00 ${ampm}`;
    }

    function fillHourSelect(sel) {
      if (!sel) return;
      sel.innerHTML = "";
      for (let h = 0; h < 24; h++) {
        const opt = document.createElement("option");
        opt.value = String(h);
        opt.textContent = hourLabel(h);
        sel.appendChild(opt);
      }
    }

    function setupScheduleUI() {
      const startSel = document.getElementById("schedStart");
      const endSel   = document.getElementById("schedEnd");
      const everySel = document.getElementById("schedEvery");
      const saveBtn  = document.getElementById("schedSaveBtn");
      const statusEl = document.getElementById("schedStatus");

      if (!startSel || !endSel || !everySel || !saveBtn) return;

      fillHourSelect(startSel);
      fillHourSelect(endSel);

      const setStatus = (text, tone) => {
        if (!statusEl) return;
        statusEl.innerText = text || "—";
        if (tone === "ok") {
          statusEl.style.borderColor = "rgba(74,222,128,0.55)";
          statusEl.style.color = "#bbf7d0";
        } else if (tone === "bad") {
          statusEl.style.borderColor = "rgba(249,115,115,0.55)";
          statusEl.style.color = "#fecaca";
        } else {
          statusEl.style.borderColor = "rgba(56,189,248,0.35)";
          statusEl.style.color = "var(--text-soft)";
        }
      };

      // Live-load current schedule
      const ref = db.ref(`devices/${activeDeviceId}/settings/doseSchedule`);
      ref.off();
      ref.on("value", snap => {
        const v = snap.val() || {};
        const startHour = (v.startHour ?? 0);
        const endHour   = (v.endHour   ?? 24); // allow 24 meaning midnight/end-of-day
        const everyMin  = (v.everyMin  ?? 60);

        // endHour might be 24; map to 0 in UI label, but keep 24 in DB if user selects midnight end.
        startSel.value = String(Number(startHour) % 24);
        endSel.value   = String(Number(endHour) % 24);
        everySel.value = String(Number(everyMin));

        // Nice summary
        setStatus(`Loaded: ${hourLabel(startSel.value)} → ${hourLabel(endSel.value)} • every ${everySel.value}m`, "info");
      });

      // Save
      saveBtn.onclick = async () => {
        try {
          saveBtn.disabled = true;
          setStatus("Saving…", "info");

          const startHour = Number(startSel.value);
          const endHour   = Number(endSel.value);
          const everyMin  = Number(everySel.value);

          if (!isFinite(startHour) || startHour < 0 || startHour > 23) return setStatus("Start hour invalid", "bad");
          if (!isFinite(endHour)   || endHour   < 0 || endHour   > 23) return setStatus("End hour invalid", "bad");
          if (![15,60,120,240].includes(everyMin)) return setStatus("Interval invalid", "bad");

          await db.ref(`devices/${activeDeviceId}/settings/doseSchedule`).set({
            startHour,
            endHour,
            everyMin,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
          });

          setStatus("✅ Saved. ESP32 will apply within a few seconds.", "ok");
        } catch (e) {
          setStatus("Error: " + (e.message || e), "bad");
        } finally {
          saveBtn.disabled = false;
        }
      };
    }

    function setupCalibrationUI() {
      const names = ["Kalkwasser (P1)", "All-For-Reef (P2)", "Magnesium (P3)", "Auxiliary (P4)"];
      const grid = document.getElementById('calGrid');
      grid.innerHTML = '';

      names.forEach((name, i) => {
        const n = i + 1;
        const card = document.createElement('div');
        card.className = 'card';
        card.style.textAlign = 'center';
        card.innerHTML = `
          <div style="font-size:0.65rem; color:var(--text-soft); margin-bottom:5px;">PUMP ${n}</div>
          <div style="font-weight:bold; margin-bottom:15px; color:var(--accent);">${name}</div>
          <button id="startCal${n}" class="btn-action" style="background:var(--success); margin:0;">Start 60s Test</button>
          <input id="calPump${n}Ml" type="number" placeholder="ml caught in 60s" style="margin: 15px 0; text-align:center;">
          <button id="saveCal${n}" class="btn-outline-soft" style="width:100%; padding: 12px;">Save flow (ml/min)</button>
          <div id="calStatus${n}" style="margin-top:10px;font-size:12px;color:var(--text-soft);text-align:center;"></div>
        `;
        grid.appendChild(card);

        const startBtn = document.getElementById(`startCal${n}`);
        startBtn.onclick = function() {
          this.disabled = true;
          db.ref(`devices/${activeDeviceId}/commands/calibrate`).set({
            trigger: true, pump: n, durationSec: 60, status: "pending", ts: Date.now()
          });

          let seconds = 60;
          const timer = setInterval(() => {
            this.innerText = `Running... ${seconds}s`;
            seconds--;
            if (seconds < 0) {
              clearInterval(timer);
              this.disabled = false;
              this.innerText = "Start 60s Test";
            }
          }, 1000);
        };

        document.getElementById(`saveCal${n}`).onclick = async () => {
          const statusEl = document.getElementById(`calStatus${n}`);
          const mlCaught = parseFloat(document.getElementById(`calPump${n}Ml`).value);
          const durationSec = 60; // test duration used by Start 60s Test
          if (!isFinite(mlCaught) || mlCaught <= 0) return alert("Measure output first (enter ml caught).");

          // Normalize to ONE unit everywhere: ml/min
          const mlPerMin = mlCaught * (60 / durationSec);

          statusEl.innerText = `Saving… (${mlPerMin.toFixed(1)} ml/min)`;
          try {
            await db.ref(`devices/${activeDeviceId}/calibration/pumps/pump${n}`).set({
              unit: "ml/min",
              durationSec: durationSec,
              ml_caught: mlCaught,
              ml_per_min: mlPerMin,
              ts: Date.now()
            });
            statusEl.innerText = `✅ Saved ${mlPerMin.toFixed(1)} ml/min. Waiting for ESP32 to apply…`;
          } catch (err) {
            statusEl.innerText = "❌ Save failed: " + (err?.message || err);
          }
        };
      });
    }

    
let calPumpsUnsub = null;
function attachCalibrationPumpsListener() {
  if (!activeDeviceId) return;
  if (calPumpsUnsub) { try { calPumpsUnsub(); } catch(e){} calPumpsUnsub = null; }

  const ref = db.ref(`devices/${activeDeviceId}/calibration/pumps`);
  const handler = (snap) => {
    const v = snap.val() || {};
    for (let n = 1; n <= 4; n++) {
      const st = document.getElementById(`calStatus${n}`);
      if (!st) continue;
      const rec = v[`pump${n}`] || {};
      const mlpm = rec.ml_per_min ?? rec.mlPerMin ?? rec.flowMlPerMin;
      if (mlpm && isFinite(Number(mlpm))) {
        // Only show "Saved" hint if user isn't currently seeing a success/fail message
        if (!st.innerText || st.innerText.startsWith("Saving") || st.innerText.startsWith("✅") || st.innerText.startsWith("❌")) {
          // keep current message
        } else {
          st.innerText = `Saved: ${Number(mlpm).toFixed(1)} ml/min (from ${rec.ml_caught ?? "?"} ml in ${rec.durationSec ?? 60}s)`;
        }
      } else {
        if (!st.innerText) st.innerText = "No saved calibration yet.";
      }
    }
  };
  ref.on('value', handler);
  calPumpsUnsub = () => ref.off('value', handler);
}

let calStatusUnsub = null;
    function attachCalibrationStatusListener() {
      if (!activeDeviceId) return;
      const ackEl = document.getElementById('calibrationAck');
      if (!ackEl) return;

      if (calStatusUnsub) { try { calStatusUnsub(); } catch(e){} calStatusUnsub = null; }
      if (calPumpsUnsub) { try { calPumpsUnsub(); } catch(e){} calPumpsUnsub = null; }

      const ref = db.ref(`devices/${activeDeviceId}/calibration/status`);
      const handler = (snap) => {
        const v = snap.val();
        if (!v) { ackEl.innerText = "No calibration status from ESP32 yet."; return; }
        const when = v.appliedAt ? new Date(v.appliedAt).toLocaleString() : "—";
        const flows = v.flows || {};
        const k = flows.kalk ?? "—";
        const a = flows.afr ?? "—";
        const m = flows.mg ?? "—";
        const x = flows.aux ?? "—";
        ackEl.innerText = `ESP32 applied: ${when}  |  KALK ${k} ml/min, AFR ${a}, MG ${m}, AUX ${x}`;
      };
      ref.on('value', handler);
      calStatusUnsub = () => ref.off('value', handler);
    }

    document.getElementById('openCalibrationBtn').onclick = () => {
      document.getElementById('calibrationOverlay').classList.remove('hidden');
      attachCalibrationStatusListener();
      attachCalibrationPumpsListener();
    };
    document.getElementById('closeCalibrationBtn').onclick = () => {
      document.getElementById('calibrationOverlay').classList.add('hidden');
      if (calStatusUnsub) { try { calStatusUnsub(); } catch(e){} calStatusUnsub = null; }
      if (calPumpsUnsub) { try { calPumpsUnsub(); } catch(e){} calPumpsUnsub = null; }
    };

    // ---- DOSE RUNS / GRAPH (NEW) ----
    function normalizePump(p) {
      const s = String(p || "").toLowerCase();
      if (s.includes("kalk")) return "kalk";
      if (s.includes("afr") || s.includes("allforreef") || s.includes("all-for-reef")) return "afr";
      if (s.includes("mg") || s.includes("mag")) return "mg";
      if (s.includes("aux") || s.includes("pump4") || s.includes("p4")) return "aux";
      return s || "other";
    }

    function computeMlFromRun(run) {
      // Preferred:
      if (typeof run.ml === "number") return run.ml;
      const ml = Number(run.ml);
      if (isFinite(ml)) return ml;

      // Optional support: duration -> ml
      const durationSec = Number(run.durationSec || run.duration || 0);
      const mlPerMin = Number(run.ml_per_min || run.mlPerMin || 0);
      if (durationSec > 0 && mlPerMin > 0) {
        return (durationSec / 60) * mlPerMin;
      }
      return NaN;
    }

    function fmtTs(ts) {
      const t = Number(ts || 0);
      if (!t) return "—";
      return new Date(t).toLocaleString();
    }

    function renderDoseGraph(rows) {
      const meta = document.getElementById("doseGraphMeta");
      const tbody = document.getElementById("doseRunsBody");
      const ctx = document.getElementById("doseChart").getContext("2d");

      const filtered = rows
        .filter(r => isFinite(r.ml) && r.ml >= 0)
        .filter(r => doseFilter === "all" ? true : r.pump === doseFilter)
        .sort((a,b) => (a.ts||0) - (b.ts||0));

      meta.textContent = `${filtered.length} runs shown`;

      // Table (latest 60)
      tbody.innerHTML = "";
      [...filtered].reverse().slice(0, 60).forEach(r => {
        tbody.innerHTML += `<tr>
          <td>${fmtTs(r.ts)}</td>
          <td>${r.pump}</td>
          <td>${r.ml.toFixed(1)}</td>
        </tr>`;
      });

      // Chart
      if (doseChart) doseChart.destroy();

      doseChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: filtered.map(r => new Date(r.ts).toLocaleString()),
          datasets: [{
            label: "ml per run",
            data: filtered.map(r => r.ml),
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function attachDoseRunsListener() {
      if (!activeDeviceId) return;

      if (doseRunsUnsub) { try { doseRunsUnsub(); } catch(e){} doseRunsUnsub = null; }

      // last N runs is plenty for graph UI; your prune function keeps 365 days anyway.
      const ref = db.ref(`devices/${activeDeviceId}/doseRuns`).limitToLast(800);

      const handler = (snap) => {
        const obj = snap.val() || {};
        const rows = Object.values(obj).map(r => ({
          pump: normalizePump(r.pump || r.pumpName || r.type || ""),
          ml: computeMlFromRun(r),
          ts: Number(r.ts || r.timestamp || 0)
        })).filter(r => r.ts);

        renderDoseGraph(rows);
      };

      ref.on("value", handler);
      doseRunsUnsub = () => ref.off("value", handler);
    }

    function setDoseFilter(f) {
      doseFilter = f;
      attachDoseRunsListener(); // quick refresh
    }

    document.getElementById("openDoseGraphBtn").onclick = () => {
      document.getElementById("doseGraphOverlay").classList.remove("hidden");
      attachDoseRunsListener();
    };

    // Same action button inside the Device card
    const btn2 = document.getElementById("openDoseGraphBtn2");
    if (btn2) btn2.onclick = document.getElementById("openDoseGraphBtn").onclick;

    document.getElementById("closeDoseGraphBtn").onclick = () => {
      document.getElementById("doseGraphOverlay").classList.add("hidden");
      if (doseRunsUnsub) { try { doseRunsUnsub(); } catch(e){} doseRunsUnsub = null; }
    };

    document.getElementById("doseTabAll").onclick  = () => setDoseFilter("all");
    document.getElementById("doseTabKalk").onclick = () => setDoseFilter("kalk");
    document.getElementById("doseTabAfr").onclick  = () => setDoseFilter("afr");
    document.getElementById("doseTabMg").onclick   = () => setDoseFilter("mg");
    document.getElementById("doseTabAux").onclick  = () => setDoseFilter("aux");

    // ---- PUSH ENABLE (iPhone PWA) ----
    async function enableIphonePush() {
      const statusEl = document.getElementById("pushStatus");
      const setStatus = t => statusEl.textContent = t;

      try {
        if (!activeDeviceId) {
          alert("No device selected yet.");
          return;
        }
        if (!("serviceWorker" in navigator)) {
          alert("Service workers not supported.");
          return;
        }

        setStatus("Registering service worker...");
        const reg = await navigator.serviceWorker.register("/firebase-messaging-sw.js");

        setStatus("Requesting notification permission...");
        const permission = await Notification.requestPermission();
        if (permission !== "granted") {
          setStatus("Permission denied");
          return;
        }

        const VAPID_KEY = "BAyKJV9NRCycwmCmtNLKtGhOZJbe47uHKbfK_WVsMpszIlxVYOG8ptSwgfZCrpFRAuodt6G3hM5NgW_jMWYk-Yg";

        setStatus("Getting push token...");
        const messaging = firebase.messaging();
        const token = await messaging.getToken({ vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });

        if (!token) {
          setStatus("No token received");
          return;
        }

        const uid = auth.currentUser.uid;
        const meta = { ts: Date.now(), platform: "ios-pwa", ua: navigator.userAgent };

        await db.ref(`users/${uid}/pushTokens/${token}`).set(meta);
        await db.ref(`devices/${activeDeviceId}/pushTokens/${token}`).set(meta);

        setStatus("Push enabled ✅");
        alert("iPhone notifications enabled!");
      } catch (err) {
        console.error(err);
        document.getElementById("pushStatus").textContent = "Push error";
        alert("Push failed: " + err.message);
      }
    }

    document.getElementById("enablePushBtn").addEventListener("click", enableIphonePush);
  </script>
</body>
</html>